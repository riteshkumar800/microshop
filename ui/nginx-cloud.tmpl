# /etc/nginx/templates/default.conf.template
server {
  # Render assigns $PORT; default to 80 for local runs
  listen ${PORT:-80};
  server_name _;

  # static UI
  root /usr/share/nginx/html;
  index index.html;

  # simple health
  location = /healthz {
    add_header Content-Type application/json;
    return 200 '{"ok":true}';
  }

  # SPA fallback
  location / {
    try_files $uri /index.html;
  }

  # ---------- Common proxy settings ----------
  proxy_http_version 1.1;
  proxy_set_header Connection "";
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-For $remote_addr;
  proxy_set_header X-Forwarded-Host $host;

  # Important for Render upstreams over HTTPS
  proxy_ssl_server_name on;
  # Use the host from proxy_pass as both SNI and HTTP Host
  proxy_set_header Host $proxy_host;

  # ---------- Products ----------
  location /api/products/ { proxy_pass ${PRODUCT_ORIGIN}/products/; }
  location = /api/products  { proxy_pass ${PRODUCT_ORIGIN}/products;  }

  # ---------- Auth / Users ----------
  location /api/auth/ { proxy_pass ${USER_ORIGIN}/auth/; }
  location = /api/auth  { proxy_pass ${USER_ORIGIN}/auth;  }

  # ---------- Orders ----------
  location /api/orders/ { proxy_pass ${ORDER_ORIGIN}/orders/; }
  location = /api/orders  { proxy_pass ${ORDER_ORIGIN}/orders;  }

  # ---------- Payment ----------
  location /api/pay/ { proxy_pass ${PAYMENT_ORIGIN}/pay/; }
  location = /api/pay  { proxy_pass ${PAYMENT_ORIGIN}/pay;  }
}
