server {
    listen 80;
    server_name _;

    # Serve the SPA
    root /usr/share/nginx/html;
    index index.html;
    location / { try_files $uri /index.html; }

    # ---------- common proxy bits (needed for Render HTTPS upstreams)
    proxy_http_version 1.1;
    proxy_ssl_server_name on;                 # SNI
    proxy_set_header Connection "";
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $proxy_host;        # let upstream see its own host
    proxy_set_header X-Forwarded-Host $host;

    # ---------- Products
    location /api/products/      { proxy_pass ${PRODUCT_ORIGIN}/products/; }
    location = /api/products     { proxy_pass ${PRODUCT_ORIGIN}/products; }
    # convenience
    location = /api/products/healthz { proxy_pass ${PRODUCT_ORIGIN}/healthz; }

    # ---------- Auth (user service lives at ROOT, not /auth)
    location /api/auth/          { proxy_pass ${USER_ORIGIN}/; }
    location = /api/auth         { proxy_pass ${USER_ORIGIN}/; }
    location = /api/auth/healthz { proxy_pass ${USER_ORIGIN}/healthz; }

    # ---------- Orders
    location /api/orders/        { proxy_pass ${ORDER_ORIGIN}/orders/; }
    location = /api/orders       { proxy_pass ${ORDER_ORIGIN}/orders; }
    location = /api/orders/healthz { proxy_pass ${ORDER_ORIGIN}/healthz; }

    # ---------- Payments
    location /api/pay/           { proxy_pass ${PAYMENT_ORIGIN}/pay/; }
    location = /api/pay          { proxy_pass ${PAYMENT_ORIGIN}/pay; }
    location = /api/pay/healthz  { proxy_pass ${PAYMENT_ORIGIN}/healthz; }
}
