<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Microshop</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0f172a; color:#e5e7eb; }
    .wrap { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 32px; margin: 0 0 8px; }
    .muted { color:#94a3b8; font-size:14px; }
    .box { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; margin:16px 0; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input, button { height:36px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; padding:0 10px; }
    input::placeholder { color:#6b7280; }
    button { background:#0ea5e9; border-color:#0284c7; color:white; cursor:pointer; }
    button.ghost { background:transparent; border-color:#374151; color:#e5e7eb; }
    button.warn { background:#f97316; border-color:#ea580c; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-top:1px solid #1f2937; padding:10px; }
    th { text-align:left; color:#94a3b8; font-weight:600; }
    .right { text-align:right; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; background:#0b1220; border:1px solid #374151; font-size:12px; color:#93c5fd; }
    #out { white-space:pre-wrap; background:#0b1220; border:1px dashed #374151; border-radius:10px; padding:12px; color:#e5e7eb; min-height:22px; }
    .toggle { float:right; font-size:14px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Microshop <span class="toggle"><button class="ghost" id="themeBtn">üåô Dark</button></span></h1>
  <div class="muted">Gateway at <code>/api/*</code> ‚Üí Traefik ‚Üí services</div>

  <!-- Account -->
  <div class="box">
    <h3>Account</h3>
    <div class="row">
      <input id="email" placeholder="email@example.com" style="width:320px" />
      <input id="password" placeholder="password" type="password" style="width:240px" />
      <button onclick="register()">Register</button>
      <button onclick="login()">Login</button>
      <button class="ghost" onclick="logout()">Logout</button>
    </div>
    <div style="margin-top:8px;">Logged in: <span id="logged" class="pill">n/a</span></div>
  </div>

  <!-- Products -->
  <div class="box">
    <h3>Products</h3>
    <div class="row">
      <input id="pname" placeholder="Name (e.g., Keyboard)" style="flex:2;" />
      <input id="pprice" placeholder="Price (e.g., 999)" style="flex:1;" />
      <input id="pstock" placeholder="Stock (e.g., 10)" style="flex:1;" />
      <button onclick="addProduct()">Add product</button>
      <button class="ghost" onclick="seed()">Seed 2 sample items</button>
      <button class="ghost" onclick="listProducts()">Refresh</button>
    </div>
    <table style="margin-top:10px;">
      <thead><tr><th style="width:60px">ID</th><th>Name</th><th class="right">Price</th><th class="right">Stock</th><th class="right">Action</th></tr></thead>
      <tbody id="ptbody"></tbody>
    </table>
  </div>

  <!-- Cart -->
  <div class="box">
    <h3>Cart</h3>
    <table>
      <thead><tr><th>Product ID</th><th class="right">Qty</th><th class="right">Remove</th></tr></thead>
      <tbody id="cartbody"></tbody>
    </table>
    <div class="row" style="justify-content:flex-end; margin-top:10px;">
      <button class="ghost" onclick="clearCart()">Clear cart</button>
      <button class="warn" onclick="placeOrder()">Place order</button>
    </div>
  </div>

  <!-- Output -->
  <div class="box">
    <h3>Output</h3>
    <div id="out">(messages appear here)</div>
  </div>
</div>

<script>
  // THEME
  const themeBtn = document.getElementById('themeBtn');
  function setTheme(mode) {
    document.documentElement.style.colorScheme = mode === 'dark' ? 'dark' : 'light';
    themeBtn.textContent = mode === 'dark' ? 'üåô Dark' : '‚òÄÔ∏è Light';
    localStorage.setItem('theme', mode);
  }
  themeBtn.onclick = () => setTheme(localStorage.getItem('theme') === 'dark' ? 'light':'dark');
  setTheme(localStorage.getItem('theme') || 'dark');

  // UTIL
  const $ = sel => document.querySelector(sel);
  function setOut(msg){ $('#out').textContent = typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2); }

  // One-shot fetch helper: reads body ONCE, returns JSON or text. Throws on !ok with message.
  async function req(path, opts = {}) {
    const res = await fetch(path, opts);
    const raw = await res.text();
    let data; try { data = JSON.parse(raw); } catch { data = raw; }
    if (!res.ok) {
      const msg = (data && data.detail) || (data && data.message) || (typeof data === 'string' ? data : JSON.stringify(data));
      throw new Error(msg || `HTTP ${res.status}`);
    }
    return data;
  }

  // AUTH
  let token = localStorage.getItem('token') || '';
  function updateLogged(email) {
    $('#logged').textContent = email || (token ? '(token present)' : 'n/a');
  }

  async function register() {
    const email = $('#email').value.trim();
    const password = $('#password').value;
    try {
      await req('/api/auth/register', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ email, password })
      });
      setOut('Registered. Now click ‚ÄúLogin‚Äù.');
    } catch (e) { setOut('Register failed: ' + e.message); }
  }

  async function login() {
    const email = $('#email').value.trim();
    const password = $('#password').value;
    try {
      const data = await req('/api/auth/login', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ email, password })
      });
      token = data.token;
      localStorage.setItem('token', token);
      updateLogged(email);
      setOut('Logged in.');
    } catch (e) { setOut('Login failed: ' + e.message); }
  }

  function logout() {
    token = '';
    localStorage.removeItem('token');
    updateLogged('');
    setOut('Logged out.');
  }

  // PRODUCTS
  async function listProducts() {
    try {
      const list = await req('/api/products');
      const tb = $('#ptbody'); tb.innerHTML = '';
      for (const p of list) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td class="right">‚Çπ${p.price}</td>
          <td class="right">${p.stock}</td>
          <td class="right"><button class="ghost" onclick="cartAdd(${p.id})">Add to cart</button></td>`;
        tb.appendChild(tr);
      }
      setOut(`Fetched ${list.length} products.`);
    } catch (e) { setOut('List failed: ' + e.message); }
  }

  async function addProduct() {
    const name = $('#pname').value.trim();
    const price = Number($('#pprice').value);
    const stock = Number($('#pstock').value);
    if (!name || !Number.isFinite(price) || !Number.isFinite(stock)) {
      setOut('Enter valid name, price, stock.'); return;
    }
    try {
      await req('/api/products', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ name, price, stock })
      });
      setOut('Product added.'); $('#pname').value=''; $('#pprice').value=''; $('#pstock').value='';
      listProducts();
    } catch (e) { setOut('Add failed: ' + e.message); }
  }

  async function seed() {
    try {
      await req('/api/products', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ name:'Keyboard', price:999, stock:10 }) });
      await req('/api/products', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ name:'Mouse',    price:499, stock:20 }) });
      setOut('Seeded 2 items.'); listProducts();
    } catch (e) { setOut('Seed failed: ' + e.message); }
  }

  // CART
  const cart = new Map(); // id -> qty
  function renderCart() {
    const tb = $('#cartbody'); tb.innerHTML = '';
    for (const [id, qty] of cart.entries()) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${id}</td>
        <td class="right">
          <button class="ghost" onclick="cartDec(${id})">‚àí</button>
          <span style="padding:0 10px">${qty}</span>
          <button class="ghost" onclick="cartInc(${id})">+</button>
        </td>
        <td class="right"><button class="ghost" onclick="cartDel(${id})">Remove</button></td>`;
      tb.appendChild(tr);
    }
  }
  function cartAdd(id){ cart.set(id, (cart.get(id)||0)+1); renderCart(); }
  function cartInc(id){ cart.set(id, (cart.get(id)||0)+1); renderCart(); }
  function cartDec(id){ const n=(cart.get(id)||0)-1; if(n<=0) cart.delete(id); else cart.set(id,n); renderCart(); }
  function cartDel(id){ cart.delete(id); renderCart(); }
  function clearCart(){ cart.clear(); renderCart(); setOut('Cart cleared.'); }

  async function placeOrder() {
    if (!token) { setOut('Please login first.'); return; }
    const items = [...cart.entries()].map(([product_id, qty]) => ({ product_id, qty }));
    if (!items.length) { setOut('Cart is empty.'); return; }
    try {
      const data = await req('/api/orders', {
        method:'POST',
        headers:{ 'content-type':'application/json', 'Authorization':'Bearer '+token },
        body: JSON.stringify({ items })
      });
      setOut(data);
      clearCart();
      listProducts(); // to show stock decrement
    } catch (e) { setOut('Order failed: ' + e.message); }
  }

  // INIT
  (async function init(){
    updateLogged('');
    await listProducts().catch(()=>{});
  })();
</script>
</body>
</html>
